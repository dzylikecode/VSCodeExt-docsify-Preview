<!--injected by docsify preivew-->
<script>
  const log = (msg) => {
    console.log("localhost:");
    console.log(msg);
  };
  window.onbeforeunload = function (e) {
    localStorage.setItem("scrollpos", document.scrollingElement.scrollTop);
  };
  const websocket = new WebSocket("ws://" + document.location.host);
  let isConnected = false;
  websocket.onopen = () => {
    log("connected");
    isConnected = true;
  };
  websocket.onmessage = (event) => {
    log(event.data);
    let message = JSON.parse(event.data);
    switch (message.command) {
      // case "scroll":
      //   window.postMessage(
      //     {
      //       command: "scroll",
      //       linePercent: message.linePercent,
      //     },
      //     "*"
      //   );
      //   break;
      case "reload":
        reloadWindow();
        break;
    }
  };

  function updateScroll(linePercent) {
    const nextPosition = document.body.scrollHeight * linePercent;
    window.scroll(0, nextPosition);
  }
  function reloadWindow() {
    document.location.reload();
  }
</script>
<script>
  (function () {
    if (window.$docsify) {
      window.$docsify.plugins = [].concat(function (hook, vm) {
        hook.beforeEach(function (html) {
          let filePath = decodeURI(vm.route.path);
          // .md 结尾说明消息来自vscode的请求
          if (filePath.endsWith(".md") == false) {
            //将不是vscode的跳转请求发送给vscode
            if (filePath.endsWith("/")) {
              filePath += "README";
            }
            filePath += ".md";
            window.parent.window.postMessage(
              { command: "loaded", url: filePath },
              "*"
            );
          }
          return html;
        });

        hook.ready(function () {
          // this why I can't scroll window directly
          let scrollpos = localStorage.getItem("scrollpos") ?? 0;
          let curPos = +scrollpos;
          window.scroll(0, curPos);
        });
      }, window.$docsify.plugins);
    }
  })();
</script>
<script>
  document.addEventListener(
    "contextmenu",
    function (e) {
      // console.log(e);
      window.parent.window.postMessage(
        {
          command: "popContextMenu",
          event: {
            x: e.x,
            y: e.y,
          },
          scrollPos:
            document.scrollingElement.scrollTop / document.body.scrollHeight,
        },
        "*"
      );
    },
    false
  );
  window.onclick = function (e) {
    window.parent.window.postMessage(
      {
        command: "hideContextMenu",
      },
      "*"
    );
  };
</script>
<script>
  window.onscroll = function (event) {
    window.parent.window.postMessage(
      {
        command: "hideContextMenu",
      },
      "*"
    );
  };
  window.addEventListener("message", (event) => {
    const message = event.data; // The JSON data our extension sent
    log(JSON.stringify(message));

    switch (message.command) {
      case "scroll":
        updateScroll(message.linePercent);
        break;
    }
  });
</script>
<!-- end for docsify preview -->
